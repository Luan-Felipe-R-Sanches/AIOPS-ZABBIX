<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOPS | ZABBIX</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg: #05070a;
            --card-bg: #0f131a;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
            --border: #1e232a;
            
            /* Cores de Severidade (Neon) */
            --crit-color: #ff3333;
            --high-color: #ff8800;
            --avg-color: #ffcc00;
            --info-color: #00aaff;
            --ok-color: #00ff88;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HUD Header --- */
        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: rgba(15, 19, 26, 0.95);
            border-bottom: 2px solid var(--border);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .hud-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .hud-stats {
            display: flex;
            gap: 30px;
        }

        .stat-box {
            text-align: right;
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            line-height: 1;
            font-family: 'Roboto Mono', monospace;
        }

        /* --- Grid da TV --- */
        .tv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); /* Cards Largos */
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
            align-content: start;
        }

        /* --- Card de Incidente --- */
        .noc-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 6px solid var(--info-color); /* Default */
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .noc-card.sev-5 { border-left-color: var(--crit-color); box-shadow: 0 0 20px rgba(255, 51, 51, 0.2); animation: crit-pulse 2s infinite; }
        .noc-card.sev-4 { border-left-color: var(--high-color); }
        .noc-card.sev-3 { border-left-color: var(--avg-color); }
        .noc-card.sev-2 { border-left-color: var(--info-color); }

        /* Header do Card */
        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .host-name {
            font-size: 1.6rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .time-box {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.2rem;
            color: var(--text-muted);
            background: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 4px;
        }

        .problem-desc {
            font-size: 1.3rem;
            line-height: 1.3;
            font-weight: 500;
            color: #d1d5db;
            margin: 5px 0;
        }

        /* Tags Grandes */
        .tags-area { display: flex; gap: 8px; flex-wrap: wrap; }
        .tv-tag {
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255,255,255,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-muted);
        }

        /* Área da IA */
        .ai-panel {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            padding: 1rem;
            margin-top: auto; /* Empurra para o fundo */
        }

        .ai-title {
            color: #58a6ff;
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-text {
            font-size: 1.1rem;
            color: #adbac7;
            margin-bottom: 0.8rem;
        }

        .cmd-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 1rem;
            background: #000;
            color: #00ff88;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #00ff88;
            word-break: break-all;
            display: none; /* Só aparece se tiver comando */
        }

        /* Estados Especiais */
        .empty-wall {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-size: 2rem;
            opacity: 0.5;
        }

        @keyframes crit-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.4); border-color: rgba(255, 51, 51, 0.8); }
            70% { box-shadow: 0 0 0 20px rgba(255, 51, 51, 0); border-color: rgba(255, 51, 51, 0.3); }
            100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); border-color: rgba(255, 51, 51, 0.8); }
        }

        .wifi-ok { color: var(--ok-color); text-shadow: 0 0 10px var(--ok-color); }
        .wifi-err { color: var(--crit-color); }

    </style>
</head>
<body>

    <div class="hud-header">
        <div class="hud-title">
            <i class="fa-solid fa-network-wired" style="color: var(--info-color);"></i>
            AIOPS <span style="color: var(--info-color)">ZABBIX</span>
        </div>
        <div class="hud-stats">
            <div class="stat-box">
                <div class="stat-label">Total</div>
                <div class="stat-value" id="s-total">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label" style="color: var(--crit-color)">Críticos</div>
                <div class="stat-value" style="color: var(--crit-color)" id="s-crit">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Tokens</div>
                <div class="stat-value" style="color: var(--avg-color)" id="s-tokens">0</div>
            </div>
            <div class="stat-box" style="display: flex; align-items: center;">
                <i class="fa-solid fa-wifi fa-2x wifi-ok" id="wifi"></i>
            </div>
        </div>
    </div>

    <div class="tv-grid" id="app">
        <div class="empty-wall" id="empty-msg">
            <i class="fa-solid fa-check-circle fa-2x mb-3"></i>
            <div>SISTEMAS OPERACIONAIS</div>
        </div>
    </div>

    <template id="tpl">
        <div class="noc-card">
            <div class="card-top">
                <div class="host-name">SRV-DB-01</div>
                <div class="time-box">10:45</div>
            </div>
            
            <div class="problem-desc">CPU Utilization is too high (98%)</div>

            <div class="tags-area">
                </div>

            <div class="ai-panel">
                <div class="ai-title"><i class="fa-solid fa-microchip"></i> Análise IA</div>
                <div class="ai-text">Processando incidente...</div>
                <div class="cmd-display"></div>
            </div>
        </div>
    </template>

<script>
    const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws`);
    const app = document.getElementById('app');
    const emptyMsg = document.getElementById('empty-msg');
    const tpl = document.getElementById('tpl').content;
    let cards = {};

    // Configuração de Conexão
    ws.onopen = () => document.getElementById('wifi').className = "fa-solid fa-wifi fa-2x wifi-ok";
    ws.onclose = () => { 
        document.getElementById('wifi').className = "fa-solid fa-wifi fa-2x wifi-err"; 
        setTimeout(() => location.reload(), 5000); 
    };

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        renderHUD(data.stats);
        renderWall(data.data);
    };

    function renderHUD(s) {
        document.getElementById('s-total').innerText = s.total;
        document.getElementById('s-crit').innerText = s.critical;
        const kTokens = s.tokens > 999 ? (s.tokens/1000).toFixed(1) + 'k' : s.tokens;
        document.getElementById('s-tokens').innerText = kTokens;
    }

    function renderWall(items) {
        // Controle de Estado Vazio
        if (!items || items.length === 0) {
            emptyMsg.style.display = 'flex';
            // Remove todos os cards
            Object.values(cards).forEach(c => c.remove());
            cards = {};
            return;
        }
        emptyMsg.style.display = 'none';

        const currentIds = new Set(items.map(i => i.id));

        // Remove cards antigos
        Object.keys(cards).forEach(id => {
            if (!currentIds.has(id)) { cards[id].remove(); delete cards[id]; }
        });

        // Cria ou Atualiza Cards
        items.forEach(item => {
            let el = cards[item.id];
            
            if (!el) {
                const clone = document.importNode(tpl, true);
                el = clone.querySelector('.noc-card');
                el.id = `c-${item.id}`;
                app.appendChild(el);
                cards[item.id] = el;
            }

            // Severidade
            el.className = `noc-card sev-${item.severity}`;

            // Dados Principais
            el.querySelector('.host-name').innerText = item.host;
            el.querySelector('.time-box').innerText = item.time;
            el.querySelector('.problem-desc').innerText = item.problem;

            // Tags (Badges Grandes)
            const tagsArea = el.querySelector('.tags-area');
            tagsArea.innerHTML = '';
            if (item.tags) {
                item.tags.forEach(t => {
                    const span = document.createElement('div');
                    span.className = 'tv-tag';
                    span.innerText = t;
                    tagsArea.appendChild(span);
                });
            }

            // IA
            const aiTxt = el.querySelector('.ai-text');
            const cmd = el.querySelector('.cmd-display');

            if (item.ai_summary.includes("⚡") || item.ai_summary.includes("Aguardando")) {
                aiTxt.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analisando...';
                aiTxt.style.color = "var(--text-muted)";
                cmd.style.display = 'none';
            } else {
                aiTxt.innerText = item.ai_summary;
                aiTxt.style.color = "#adbac7";
                
                if (item.ai_action && item.ai_action !== "N/A") {
                    cmd.style.display = 'block';
                    cmd.innerText = "> " + item.ai_action;
                } else {
                    cmd.style.display = 'none';
                }
            }
        });
    }
</script>
</body>
</html>